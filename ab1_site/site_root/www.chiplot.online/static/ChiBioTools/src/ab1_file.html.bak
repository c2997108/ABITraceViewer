<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ab1 viewer</title>
    <link rel="shortcut icon" href="/static/ChiBioTools/favicon.ico" type="image/x-icon" />
    <script src="https://xiaochi-1253795707.cos.ap-guangzhou.myqcloud.com/xiaochiPlot/js/vue.global.js"></script>
<!--    <link rel="stylesheet" type="text/css" href="/static/css/plotStyle.css">-->

    <script src="/static/js/d3.v6.min.js"></script>
    <script src="https://xiaochi-1253795707.cos.ap-guangzhou.myqcloud.com/xiaochiPlot/js/axios.min.js"></script>

</head>
<style>
    *{margin: 0px;
        font-family: Arail,'Liberation Mono', Menlo, Courier, monospace;
    }
    body{
        background: linear-gradient(to right, #66c2a5, #fc8d62);
    }
    .ab1-svg-figure-box{
        width: 100%;
        overflow: scroll;
    }
    #base-info-box{
        position: fixed;
        display: none;
        font-size: 12px;

    }
    #base-symbol-box{
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
        padding: 2px;
        color: white;
    }
    #base-quality-box{
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        background-color: #779ced;
        color: white;
        padding: 2px;
    }
    #ab1-file-drag-box{
        color: #bbb;
        background-color: #eeeeee;
        width: 60%;
        margin: auto;
        text-align: center;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border-radius: 6px;
        margin-top: 10px;
        cursor: pointer;
        border:dashed 4px #eeeeee;

        
    }
    .loading::before {
        content: " ";
        display: inline-block;
        width: 80px;
        height: 80px;
        vertical-align: middle;
        margin: auto;
        -webkit-animation: wx-button-loading-animate 1s steps(12,end) infinite;
        animation: cuIcon-spin 1s steps(12,end) infinite;
        background-size: 100%;

        background-image: url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iciIgd2lkdGg9JzEyMHB4JyBoZWlnaHQ9JzEyMHB4JyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICAgIDxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJub25lIiBjbGFzcz0iYmsiPjwvcmVjdD4KICAgIDxyZWN0IHg9JzQ2LjUnIHk9JzQwJyB3aWR0aD0nNycgaGVpZ2h0PScyMCcgcng9JzUnIHJ5PSc1JyBmaWxsPScjRTlFOUU5JwogICAgICAgICAgdHJhbnNmb3JtPSdyb3RhdGUoMCA1MCA1MCkgdHJhbnNsYXRlKDAgLTMwKSc+CiAgICA8L3JlY3Q+CiAgICA8cmVjdCB4PSc0Ni41JyB5PSc0MCcgd2lkdGg9JzcnIGhlaWdodD0nMjAnIHJ4PSc1JyByeT0nNScgZmlsbD0nIzk4OTY5NycKICAgICAgICAgIHRyYW5zZm9ybT0ncm90YXRlKDMwIDUwIDUwKSB0cmFuc2xhdGUoMCAtMzApJz4KICAgICAgICAgICAgICAgICByZXBlYXRDb3VudD0naW5kZWZpbml0ZScvPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyM5Qjk5OUEnCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSg2MCA1MCA1MCkgdHJhbnNsYXRlKDAgLTMwKSc+CiAgICAgICAgICAgICAgICAgcmVwZWF0Q291bnQ9J2luZGVmaW5pdGUnLz4KICAgIDwvcmVjdD4KICAgIDxyZWN0IHg9JzQ2LjUnIHk9JzQwJyB3aWR0aD0nNycgaGVpZ2h0PScyMCcgcng9JzUnIHJ5PSc1JyBmaWxsPScjQTNBMUEyJwogICAgICAgICAgdHJhbnNmb3JtPSdyb3RhdGUoOTAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNBQkE5QUEnCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgxMjAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNCMkIyQjInCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgxNTAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNCQUI4QjknCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgxODAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNDMkMwQzEnCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgyMTAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNDQkNCQ0InCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgyNDAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNEMkQyRDInCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgyNzAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNEQURBREEnCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgzMDAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0PgogICAgPHJlY3QgeD0nNDYuNScgeT0nNDAnIHdpZHRoPSc3JyBoZWlnaHQ9JzIwJyByeD0nNScgcnk9JzUnIGZpbGw9JyNFMkUyRTInCiAgICAgICAgICB0cmFuc2Zvcm09J3JvdGF0ZSgzMzAgNTAgNTApIHRyYW5zbGF0ZSgwIC0zMCknPgogICAgPC9yZWN0Pgo8L3N2Zz4=);

    }
    @keyframes cuIcon-spin {
        0% {
            -webkit-transform: rotate(0);
            transform: rotate(0);
        }

        100% {
            -webkit-transform: rotate(359deg);
            transform: rotate(359deg);
        }
    }
    #container{
        width: 98%;
        margin: auto;
        margin-top: 20px;
    }
    .section_title{
        padding: 5px;
        font-size: 20px;
        background-color: #663355;
        /*background-color: #8da0cb;*/
        color: white;
        margin: auto;
        font-weight: bold;
        margin-top: 20px;
    }
    td {border:1px solid #dddddd;padding:5px;font-size:12px;}
    .col1{
        font-weight: bold;
    }
    table {
        border:1px solid #999999;
        padding:2px;
        border-collapse:collapse;
        width:800px;
        margin-top: 20px;
    }
    .sequence-box{
        width: 800px;
        margin-top: 20px;
        border-radius: 4px;
        background-color: #2d2d2d;
        overflow: scroll;
        /*position: absolute;*/


    }
    .sequence-box button{
        float: right;

        margin-top:6px;
        margin-right:6px;
        display:flex;
        justify-content:center;
        align-items:center;
        width:32px;
        height:24px;
        cursor:pointer;
        font-size:14px;
        padding:0;
        border:none;
        border-radius:6px;
        color:#ccc;
        background-color:hsla(0,0%,90.2%,.2);
        box-shadow:0 2px 0 0 rgba(0,0,0,.25);


    }
    pre{
        color: white;
        padding: 10px;

    }
    #tip-box{
        padding: 5px;
        width: 200px;
        font-size: 20px;
        background-color: white;
        box-shadow: 0px 0px 10px #ccc;
        position: fixed;
        text-align: center;
        left: 50%;
        margin-left: -100px;
        top: -50px;
        border-radius: 4px;
    }
    #qrCode-out-box{
        position: fixed;


        width: 200px;
        /*height: 300px;*/
        /*background-color: red;*/
        bottom: 4px;
        right: 40px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        /*z-index: 222;*/
    }
    #qrCode-box{

        width: 100%;
        height: 60px;
        /*background-color: green;*/
        margin-top: 10px;

        display: flex;
        justify-content: space-around;
    }
    .qrCode-item-box{
        width: 40px;
        height: 40px;
        /*background-color: aqua;*/
        border-radius: 100%;
        border: solid 1px white;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .qrCode-item-box:hover{
        background-color: darkgrey;
    }
    .qrCode-item-box img{
        width: 30px;
        height: 30px;

    }
    #qrCode-img-box{
        /*height: 220px;*/
        /*background-color: aqua;*/
        display: flex;
        justify-content: space-around;
    }
    .qrCode-img-item-box{
        /*width: 200px;*/
        background-color: rgba(0,0,0,0.5);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        color: white;
        padding: 20px;
        box-shadow: 0px 0px 10px white;
    }
    .qrCode-img-item-box img{
        width: 160px;
        border-radius: 10px;
    }
    @keyframes ghostUpdown {
        from {
            bottom: 50px;
        }
        to {
            bottom: 70px;
        }
    }

    #hand-box{
        width: 110px;
        height: 120px;
        /*background-color: red;*/
        position: absolute;
        bottom: 50px;
        right: 0px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        animation: ghostUpdown 0.8s infinite alternate;
    }
    #hand-imgbox{
        transform: rotate(90deg);
        width: 40px;
    }
</style>
<body>
<div id="base-info-box">
    <div id="base-symbol-box">A939</div>
    <div id="base-quality-box">峰高：1197 质量：33</div>
</div>
<div id="ab1-file-drag-box" >
    <h1 style="margin-top: 10px;">Drag and drop or click here</h1>
    to view ab1 file from your computer.
</div>
<div id="tip-box">Copy succeeded</div>
<div id="container">
    <div class="section_title" >Summary</div>

    <table >
        <tbody id="summary-table-body"></tbody>
    </table>

    <div class="section_title" >Peak figure</div>

    <div class="ab1-svg-figure-box">
        <svg id="svg" height="0" style="margin-top: 20px;background-color: white;"></svg>
    </div>

    <div class="section_title" >Sequence</div>
    <div class="sequence-box">
        <button id="copy-btn" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button>
        <pre class="line-numbers  language-bash"><code id="code-box"></code>
    </pre>
    </div>

</div>
<div style="height: 20px;opacity: 0;"></div>
<div id="qrcode-app" v-cloak>
    <qrcode-box></qrcode-box>
</div>


</body>
<script type="module">

    import {FileManager} from "/static/xiaochiPlot/js/filemanager.js"
    import {Http} from "/static/xiaochiPlot/js/http.js"
    import {FooterQRCode} from "/static/js/footerQRCode.js"


    class AB1 {
        constructor() {
            this.plotType = "kegg"
        new FooterQRCode(this)
        this.uploadAb1File()
            this.fileManager = new FileManager()
            this.http = new Http()

            this.http.get("/xiaochi/gettoken").then(
                function (res){

                    console.log(res)

            }).catch(function (err){
                console.log(err)
            })


            this.svg = d3.select("#svg");
            this.tbody = d3.select("#summary-table-body");



        }
        init(data){

            console.log(data)

            this.svg.text("")

            this.ab1Data = data

            // 定义画布
            this.width = this.ab1Data.peakData.length;
            this.height = 300;
            this.margin = {top:10, left:10, bottom:80, right:10}
            this.innerwidth = this.width - this.margin.left - this.margin.right
            this.innerHeight = this.height - this.margin.top - this.margin.bottom
            this.svg.attr("xmlns","http://www.w3.org/2000/svg")
                .attr("xmlns:xlink","http://www.w3.org/1999/xlink")
                .attr('viewBox',`0 0 ${this.width} ${this.height}`)
                .attr("width",this.width)
                .attr("height",this.height)


            //创建一个主绘图组
            this.maingroup = this.svg.append('g').attr('id',"maingroup")
                .attr('transform',`translate(${this.margin.left},${this.margin.top})`)

            //创建一个颜色映射
            this.colorScale = d3.scaleOrdinal()
                .domain(this.ab1Data.peakData.channels)
                .range(["#121112", "#35ce36", "#fc4136", "#4169e0" ])

            this.addAxis()
            this.drawArea()
            this.drawBar()
            this.drawSummaryTable()





        }
        uploadAb1File(){
            const self = this
            let file_drag_box = d3.select("#ab1-file-drag-box")

            function request(fileList) {
                file_drag_box
                .classed("loading",true)
                let param = new FormData(); // 创建form对象
                param.append("file", fileList[0]); // 通过append向form对象添加数据

                // param.append("chunk", "别的数据"); // 添加form表单中其他数据
                console.log(param.get("file")); // FormData私有类对象，访问不到，可以通过get判断值是否传进去

                let config = {
                    headers: { "Content-Type": "multipart/form-data" }
                };

                self.http.post("/ChiBioTools/getAb1Data", param, config).then(data=>{
                    data.baseData = d3.tsvParse(data.baseData, d3.autoType)
                    self.init(data)
                    file_drag_box.classed("loading",false)
                }).catch(err=>{
                    file_drag_box.classed("loading",false)
                })
            }

            file_drag_box
            .on("click",function (){
                console.log("uploadfile")
              self.fileManager.openFile({
                  multiple:false,
                  types: [
                      {
                          description: 'ab1',
                          accept: {
                              'ab1/*': ['.ab1']
                          }
                      },
                  ],
              }).then(fileList=>{

                  request(fileList)



              })


            })
            .on("dragover",function (e){
                e.preventDefault();//要这个阻止，下面的drop才能触发
                  //拖入文件后边框颜色变红
                this.style.borderColor = '#ccc';
            }).on("dragleave",function (e){

                    e.preventDefault();
                this.style.borderColor = '#eee';
            })
            .on("drop",function (e){

                e.preventDefault();
                let fileList = e.dataTransfer.files;
               request(fileList)
                this.style.borderColor = '#eee';


            })

        }

        addAxis(){

            let x_max = this.ab1Data.peakData.length
            // let x_max = 100

            let y_max = d3.max(this.ab1Data.peakData.channels.map(c=>{
                return d3.max(this.ab1Data.peakData[c])
            }))

            console.log(x_max,y_max)


            //创建坐标轴
            const xScale = d3.scaleLinear().domain([0,x_max]).range([0,this.innerwidth]);

            const yScale = d3.scaleLinear().domain([y_max, 0]).range([0, this.innerHeight]);

            this.xScale = xScale
            this.yScale = yScale

            //创建坐标轴
            const yAxis = d3.axisLeft(yScale).tickSizeOuter(0);
            const xAxis = d3.axisBottom(xScale).tickSizeOuter(0);






            // const xAxisGroup = this.maingroup.append('g').call(xAxis).attr('id','xAxis').attr('transform',`translate(0,${this.innerHeight})`)



            // const yAxisGroup = this.maingroup.append('g').call(yAxis).attr('id','yAxis');







        }
        drawArea(){
            const area = d3.area()
            .x((d,i)=>this.xScale(i))
            .y0(this.yScale(0))
            .y1((d,i)=>this.yScale(d))



            const areaG = this.maingroup.append("g")

            this.ab1Data.peakData.channels.forEach(channel=>{
            areaG.append("path")
                    .datum(this.ab1Data.peakData[channel])
                    .attr('d',area)
                    .attr('fill',this.colorScale(channel))
                    .attr('fill-opacity',"0.2")
                    .attr('stroke',this.colorScale(channel))
            })

            const baseSymbolG = this.maingroup.append("g")



            this.baseColorScale = d3.scaleOrdinal()
                .domain(["G", "A", "T", "C"])
                .range(["#121112", "#35ce36", "#fc4136", "#4169e0" ])

            baseSymbolG.selectAll("basetext")
                .data(this.ab1Data.baseData)
                .join("text")
                .text(d=>d.base_symbol)
                .attr("x",d=>this.xScale(d.base_location))
                .attr("font-size",10)
                .attr("text-anchor", "middle")
                .attr("fill", d=>this.baseColorScale(d.base_symbol))




        }
        drawBar(){
            const self = this
            let barWidth = 6
            let barPlotHeight = 60
            let yScale = d3.scaleLinear().domain([0, d3.max(this.ab1Data.baseData, d=>d.base_quality)*1.1].reverse()).range([0,barPlotHeight])

            const barPlotG = this.maingroup.append("g")
                .attr("transform",`translate(0,${this.innerHeight})`)

            // const yAxis = d3.axisLeft(yScale).ticks(4)
            //
            // barPlotG.append("g").call(yAxis)

                const rectG = barPlotG
            .selectAll("qualityBar")
            .data(this.ab1Data.baseData)
            .join("rect")
            .attr("x",d=>this.xScale(d.base_location)-barWidth/2)
            .attr("y",d=>yScale(d.base_quality))
            .attr("width",barWidth)
            .attr("height",d=>barPlotHeight-yScale(d.base_quality))
            .attr("fill","#a0a09f")

            barPlotG
                .selectAll("barindex")
                .data(this.ab1Data.baseData.filter((d,i)=>i%30==0))
                .join("text")
            .text(d=>self.ab1Data.baseData.indexOf(d)+1)
            .attr("fill","black")
                .attr("x",d=>this.xScale(d.base_location))
                .attr("y",barPlotHeight+10)
                .attr("text-anchor", "middle")
                .attr("font-size",10)


            let base2channels = d3.scaleOrdinal()
                .domain(["G", "A", "T", "C"])
                .range(this.ab1Data.peakData.channels)

            rectG.clone()
                .attr("y",-this.innerHeight)
            .attr("height",this.innerHeight+barPlotHeight)
                .attr("fill","black")
                .attr("fill-opacity",0)

            .on("mouseover",function (e){
                    let clientX = e.clientX
                    let clientY = e.clientY

                if(clientX+170>window.innerWidth){
                    clientX -= 190
                }
                let data = d3.select(this).data()[0]
                d3.select(this)
                    .attr("fill-opacity",0.2)

                    d3.select("#base-info-box")
                    .style("display",`flex`)
                    .style("left",`${clientX+20}px`)
                    .style("top",`${clientY-20}px`)

                d3.select("#base-symbol-box")
                .text(`${data.base_symbol}${self.ab1Data.baseData.indexOf(data)+1}`)
                .style("background-color", d3.color(self.baseColorScale(data.base_symbol)).formatRgb().replace(")",",0.8)").replace("rgb","rgba"))

                d3.select("#base-quality-box")
                .text(`峰高：${self.ab1Data.peakData[base2channels(data.base_symbol)][data.base_location]} 质量：${data.base_quality}`)
            })
            .on("mouseleave",function (){
                    d3.select(this)
                        .attr("fill-opacity",0)

                d3.select("#base-info-box")
                    .style("display",`none`)


                })


        }
        drawSummaryTable(){
            this.tbody.text("")
            this.tbody.selectAll("tr")
            .data(this.ab1Data.summary)
            .join("tr")
            .each(function (d){
                let tr =  d3.select(this)
                for(let k in d){
                    tr.append("td").text(`${k}:`).attr("class","col1")
                    tr.append("td").text(d[k])
                }

            })
            d3.select("#code-box").text(`>${this.ab1Data.summary[0]["file name"]}\n`+this.ab1Data.baseData.map((d,i)=>{
                return `${d.base_symbol}${(i+1)%80==0?"\n":""}`
            }).join(""))
            d3.select("#copy-btn").on("click",function (){
                navigator.clipboard.writeText(d3.select("#code-box").text()).then(res=>{
                    d3.select("#tip-box")
                        .style("top","-50px")
                        .style("opacity",0)
                        .transition()
                        .ease(d3.easeBounceOut)
                        .duration(600)
                        .style("top","100px")
                        .style("opacity",1)
                        .transition()
                        .duration(600)
                        .ease(d3.easeCubicIn)
                        .style("opacity",0)
                        .transition()
                        .duration(600)
                        .style("top","-50px")

                })
            })

        }






    }

    const ab1  = new AB1()


</script>
</html>